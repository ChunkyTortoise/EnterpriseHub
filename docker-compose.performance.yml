version: '3.8'

# =========================================================================
# Jorge's Revenue Acceleration Platform - Performance-Optimized Configuration
# =========================================================================
# Purpose: High-performance production deployment with load balancing
# Target: 1000+ req/sec, <100ms response times, 99.9% uptime
# Author: Claude Code Performance Optimization Agent
# Created: 2026-01-17
# =========================================================================

services:
  # =========================================================================
  # NGINX Load Balancer (Layer 7)
  # =========================================================================
  nginx-load-balancer:
    image: nginx:1.25-alpine
    container_name: jorge-nginx-lb
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-cache:/var/cache/nginx
    networks:
      - jorge-frontend
      - jorge-backend
    depends_on:
      - api-instance-1
      - api-instance-2
      - api-instance-3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # =========================================================================
  # API Instances (Horizontal Scaling - 3 instances)
  # =========================================================================
  api-instance-1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=production
    container_name: jorge-api-1
    environment:
      - INSTANCE_ID=api-1
      - WORKER_PROCESSES=4
      - WORKER_CONNECTIONS=1000
      - MAX_CONCURRENT_REQUESTS=200
      - REDIS_URL=redis://redis-cache:6379/0
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-primary:5432/jorge_platform
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GHL_API_KEY=${GHL_API_KEY}
      - GHL_LOCATION_ID=${GHL_LOCATION_ID}
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - CACHE_BACKEND=redis
      - ENABLE_PERFORMANCE_MONITORING=true
    networks:
      - jorge-backend
    depends_on:
      - postgres-primary
      - redis-cache
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  api-instance-2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=production
    container_name: jorge-api-2
    environment:
      - INSTANCE_ID=api-2
      - WORKER_PROCESSES=4
      - WORKER_CONNECTIONS=1000
      - MAX_CONCURRENT_REQUESTS=200
      - REDIS_URL=redis://redis-cache:6379/0
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-primary:5432/jorge_platform
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GHL_API_KEY=${GHL_API_KEY}
      - GHL_LOCATION_ID=${GHL_LOCATION_ID}
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - CACHE_BACKEND=redis
      - ENABLE_PERFORMANCE_MONITORING=true
    networks:
      - jorge-backend
    depends_on:
      - postgres-primary
      - redis-cache
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  api-instance-3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=production
    container_name: jorge-api-3
    environment:
      - INSTANCE_ID=api-3
      - WORKER_PROCESSES=4
      - WORKER_CONNECTIONS=1000
      - MAX_CONCURRENT_REQUESTS=200
      - REDIS_URL=redis://redis-cache:6379/0
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-primary:5432/jorge_platform
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GHL_API_KEY=${GHL_API_KEY}
      - GHL_LOCATION_ID=${GHL_LOCATION_ID}
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - CACHE_BACKEND=redis
      - ENABLE_PERFORMANCE_MONITORING=true
    networks:
      - jorge-backend
    depends_on:
      - postgres-primary
      - redis-cache
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # =========================================================================
  # PostgreSQL Primary (Optimized for Performance)
  # =========================================================================
  postgres-primary:
    image: postgres:15-alpine
    container_name: jorge-postgres-primary
    environment:
      - POSTGRES_DB=jorge_platform
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=en_US.UTF-8
      # Performance tuning
      - POSTGRES_SHARED_BUFFERS=512MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=2GB
      - POSTGRES_WORK_MEM=16MB
      - POSTGRES_MAINTENANCE_WORK_MEM=128MB
      - POSTGRES_MAX_CONNECTIONS=200
      - POSTGRES_RANDOM_PAGE_COST=1.1  # SSD optimization
      - POSTGRES_EFFECTIVE_IO_CONCURRENCY=200
      - POSTGRES_WAL_BUFFERS=16MB
      - POSTGRES_CHECKPOINT_COMPLETION_TARGET=0.9
      - POSTGRES_MAX_WAL_SIZE=2GB
      - POSTGRES_MIN_WAL_SIZE=1GB
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    networks:
      - jorge-backend
    ports:
      - "5432:5432"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # =========================================================================
  # Redis Cache (High Performance)
  # =========================================================================
  redis-cache:
    image: redis:7-alpine
    container_name: jorge-redis-cache
    command: >
      redis-server
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 60
      --maxclients 10000
      --protected-mode no
    volumes:
      - redis-data:/data
    networks:
      - jorge-backend
    ports:
      - "6379:6379"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # =========================================================================
  # Redis Sentinel (High Availability)
  # =========================================================================
  redis-sentinel:
    image: redis:7-alpine
    container_name: jorge-redis-sentinel
    command: >
      redis-sentinel /etc/redis/sentinel.conf
      --sentinel monitor jorge-redis redis-cache 6379 2
      --sentinel down-after-milliseconds jorge-redis 5000
      --sentinel parallel-syncs jorge-redis 1
      --sentinel failover-timeout jorge-redis 10000
    networks:
      - jorge-backend
    depends_on:
      - redis-cache
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped

  # =========================================================================
  # Prometheus (Metrics Collection)
  # =========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: jorge-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - jorge-backend
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # =========================================================================
  # Grafana (Performance Dashboards)
  # =========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: jorge-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - jorge-backend
      - jorge-frontend
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # =========================================================================
  # Redis Exporter (Prometheus Metrics)
  # =========================================================================
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: jorge-redis-exporter
    environment:
      - REDIS_ADDR=redis://redis-cache:6379
    networks:
      - jorge-backend
    ports:
      - "9121:9121"
    depends_on:
      - redis-cache
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # =========================================================================
  # Postgres Exporter (Prometheus Metrics)
  # =========================================================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: jorge-postgres-exporter
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-primary:5432/jorge_platform?sslmode=disable
    networks:
      - jorge-backend
    ports:
      - "9187:9187"
    depends_on:
      - postgres-primary
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

# =========================================================================
# Networks
# =========================================================================
networks:
  jorge-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  jorge-backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

# =========================================================================
# Volumes
# =========================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  nginx-cache:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
