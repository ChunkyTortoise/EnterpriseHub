name: Deploy Jorge Bot to Render

on:
  push:
    branches: [main]
    paths:
      - 'ghl_real_estate_ai/**'
      - '.github/workflows/deploy-jorge.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without file changes'
        required: false
        type: boolean
        default: false

# Only one deploy at a time; cancel any in-flight deploy if a newer push lands
concurrency:
  group: deploy-jorge
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build Docker image â Deploy to Render
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE="docker.io/chunktort/jorge-realty-ai:sha-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}"         >> "$GITHUB_OUTPUT"
          echo "Tagged as: ${IMAGE}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ghl_real_estate_ai/
          platforms: linux/amd64
          push: true
          tags: |
            chunktort/jorge-realty-ai:sha-${{ steps.meta.outputs.short_sha }}
            chunktort/jorge-realty-ai:latest
          # GHA layer cache â drastically cuts build time on unchanged layers
          cache-from: type=gha
          cache-to:   type=gha,mode=max

      - name: Trigger Render deploy
        id: render
        env:
          RENDER_API_KEY:    ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE:             ${{ steps.meta.outputs.image }}
        run: |
          RESPONSE=$(curl -sf -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "do_not_clear"}')

          DEPLOY_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))")
          echo "deploy_id=${DEPLOY_ID}" >> "$GITHUB_OUTPUT"
          echo "Deploy triggered: ${DEPLOY_ID} â image: ${IMAGE}"

      - name: Wait for deploy to go live
        env:
          RENDER_API_KEY:    ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DEPLOY_ID:         ${{ steps.render.outputs.deploy_id }}
        run: |
          echo "Polling deploy ${DEPLOY_ID} (max 6 min) ..."
          for i in $(seq 1 18); do
            sleep 20
            STATUS=$(curl -sf \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" | \
              python3 -c "import sys,json; print(json.load(sys.stdin).get('status','?'))")
            echo "[${i}/18] ${STATUS}"
            case "$STATUS" in
              live)
                echo "â Deploy is live!"
                exit 0
                ;;
              update_failed|deactivated|build_failed)
                echo "â Deploy failed with status: ${STATUS}"
                exit 1
                ;;
            esac
          done
          echo "â± Polling timed out â Render may still be deploying. Check dashboard."
          exit 1
