name: Deploy Jorge Bot to Render

on:
  push:
    branches: [main]
    paths:
      - 'ghl_real_estate_ai/**'
      - '.github/workflows/deploy-jorge.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without file changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-jorge
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Render (source)
    runs-on: ubuntu-latest
    steps:
      - name: Update Render service start command
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "Patching Render service start/build command (srv-d6d5go15pdvs73fcjjq0)..."
          PATCH_RESPONSE=$(curl -s -X PATCH \
            "https://api.render.com/v1/services/srv-d6d5go15pdvs73fcjjq0" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "serviceDetails": {
                "buildCommand": "pip install -r requirements-prod.txt",
                "startCommand": "PYTHONPATH=.. uvicorn api.main_prod:app --host 0.0.0.0 --port $PORT --workers 1"
              }
            }')
          echo "PATCH response: ${PATCH_RESPONSE}"

      - name: Trigger Render source deploy
        id: render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "Triggering Render source deploy (srv-d6d5go15pdvs73fcjjq0)..."
          RESPONSE=$(curl -s -X POST \
            "https://api.render.com/v1/services/srv-d6d5go15pdvs73fcjjq0/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{}")
          echo "API response: ${RESPONSE}"
          DEPLOY_ID=$(echo "${RESPONSE}" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))")
          echo "deploy_id=${DEPLOY_ID}" >> "$GITHUB_OUTPUT"
          echo "Deploy triggered. ID=${DEPLOY_ID}"

      - name: Wait for deploy to go live
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          DEPLOY_ID: ${{ steps.render.outputs.deploy_id }}
        run: |
          if [ -z "${DEPLOY_ID}" ]; then
            echo "No deploy ID available, waiting 5 min for deploy to settle..."
            sleep 300
            echo "Wait complete."
            exit 0
          fi
          echo "Polling deploy ${DEPLOY_ID} (max 15 min) ..."
          for i in $(seq 1 45); do
            sleep 20
            STATUS=$(curl -sf \
              "https://api.render.com/v1/services/srv-d6d5go15pdvs73fcjjq0/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" | \
              python3 -c "import sys,json; print(json.load(sys.stdin).get('status','?'))")
            echo "[${i}/45] ${STATUS}"
            if [ "$STATUS" = "live" ]; then
              echo "Deploy is live!"
              exit 0
            fi
            if [ "$STATUS" = "update_failed" ] || [ "$STATUS" = "deactivated" ] || [ "$STATUS" = "build_failed" ]; then
              echo "Deploy failed with status: ${STATUS}"
              exit 1
            fi
          done
          echo "Polling timed out after 15 min â€” Render may still be deploying."
          exit 1
