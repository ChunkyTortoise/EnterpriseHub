name: Deploy Jorge Bot to Render

on:
  push:
    branches: [main]
    paths:
      - 'ghl_real_estate_ai/**'
      - '.github/workflows/deploy-jorge.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without file changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-jorge
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build Docker image - Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE="docker.io/chunktort/jorge-realty-ai:sha-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "Tagged as: ${IMAGE}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ghl_real_estate_ai/
          platforms: linux/amd64
          push: true
          tags: |
            chunktort/jorge-realty-ai:sha-${{ steps.meta.outputs.short_sha }}
            chunktort/jorge-realty-ai:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trigger Render deploy
        id: render
        run: |
          echo "Triggering Render deploy via hook..."
          RESPONSE=$(curl -s -X POST \
            "https://api.render.com/deploy/srv-d6cecon5r7bs738qgi10?key=DD-COmdX7wk")
          echo "Hook response: ${RESPONSE}"
          if echo "${RESPONSE}" | python3 -c "import sys,json; json.load(sys.stdin)" 2>/dev/null; then
            DEPLOY_ID=$(echo "${RESPONSE}" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))")
          else
            echo "Warning: hook response is not valid JSON, continuing anyway"
            DEPLOY_ID=""
          fi
          echo "deploy_id=${DEPLOY_ID}" >> "$GITHUB_OUTPUT"
          echo "Deploy triggered. ID=${DEPLOY_ID}"

      - name: Wait for deploy to go live
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DEPLOY_ID: ${{ steps.render.outputs.deploy_id }}
        run: |
          if [ -z "${DEPLOY_ID}" ]; then
            echo "No deploy ID available, waiting 3 min for deploy to settle..."
            sleep 180
            echo "Wait complete."
            exit 0
          fi
          echo "Polling deploy ${DEPLOY_ID} (max 6 min) ..."
          for i in $(seq 1 18); do
            sleep 20
            STATUS=$(curl -sf \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" | \
              python3 -c "import sys,json; print(json.load(sys.stdin).get('status','?'))")
            echo "[${i}/18] ${STATUS}"
            if [ "$STATUS" = "live" ]; then
              echo "Deploy is live!"
              exit 0
            fi
            if [ "$STATUS" = "update_failed" ] || [ "$STATUS" = "deactivated" ] || [ "$STATUS" = "build_failed" ]; then
              echo "Deploy failed with status: ${STATUS}"
              exit 1
            fi
          done
          echo "Polling timed out - Render may still be deploying."
          exit 1
