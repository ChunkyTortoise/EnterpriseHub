name: Plugin Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pyyaml jsonschema

      - name: Run all validation tests
        run: |
          echo "Running validation tests..."

          # Skills validation
          pytest .claude/skills/scripts/integration_tests.py -v || exit 1

          # Plugin validation
          python -c "
          import json
          from pathlib import Path

          plugin_json = Path('claude-real-estate-ai-plugin/.claude-plugin/plugin.json')
          if plugin_json.exists():
              with open(plugin_json) as f:
                  plugin = json.load(f)
              print(f'âœ… Plugin: {plugin[\"name\"]} v{plugin[\"version\"]}')
          else:
              print('âš ï¸  Plugin manifest not found')
          "

      - name: Verify version consistency
        run: |
          # Get version from tag or input
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi

          echo "Release version: $VERSION"

          # Verify version in plugin.json matches tag
          PLUGIN_VERSION=$(python -c "
          import json
          with open('claude-real-estate-ai-plugin/.claude-plugin/plugin.json') as f:
              print('v' + json.load(f)['version'])
          " 2>/dev/null || echo "")

          if [ -n "$PLUGIN_VERSION" ] && [ "$PLUGIN_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch: Tag=$VERSION, Plugin=$PLUGIN_VERSION"
            exit 1
          fi

          echo "âœ… Version consistency verified"

  build-package:
    name: Build Plugin Package
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
      - uses: actions/checkout@v4

      - name: Package plugin
        run: |
          PLUGIN_DIR="claude-real-estate-ai-plugin"
          VERSION="${GITHUB_REF#refs/tags/}"

          # Create distribution directory
          mkdir -p dist

          # Create plugin archive
          tar -czf "dist/claude-real-estate-ai-plugin-${VERSION}.tar.gz" \
            "$PLUGIN_DIR"

          # Create zip for Windows users
          zip -r "dist/claude-real-estate-ai-plugin-${VERSION}.zip" \
            "$PLUGIN_DIR"

          echo "âœ… Plugin packaged"
          ls -lh dist/

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-packages
          path: dist/*

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog from commits
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          # Get previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A1 "$VERSION" | tail -1)

          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "# Changelog for $VERSION" > CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "## Changes since $PREVIOUS_TAG" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          # Group commits by type
          echo "### Features" >> CHANGELOG_RELEASE.md
          git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^feat:" | sed 's/^feat: //' >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          echo "### Bug Fixes" >> CHANGELOG_RELEASE.md
          git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^fix:" | sed 's/^fix: //' >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          echo "### Documentation" >> CHANGELOG_RELEASE.md
          git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^docs:" | sed 's/^docs: //' >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          echo "### Other Changes" >> CHANGELOG_RELEASE.md
          git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^feat:" --grep="^fix:" --grep="^docs:" --invert-grep >> CHANGELOG_RELEASE.md

          cat CHANGELOG_RELEASE.md

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG_RELEASE.md

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-package, generate-changelog]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Read changelog
        id: changelog
        run: |
          cat changelog/CHANGELOG_RELEASE.md
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog/CHANGELOG_RELEASE.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            plugin-packages/*.tar.gz
            plugin-packages/*.zip
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: true

  update-documentation:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update plugin README
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          # Update version badge in README
          sed -i "s/version-.*-blue/version-${VERSION#v}-blue/" claude-real-estate-ai-plugin/README.md || true

          # Update installation instructions
          echo "
## Installation

Download the latest release:

\`\`\`bash
# Download and extract
wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/claude-real-estate-ai-plugin-${VERSION}.tar.gz
tar -xzf claude-real-estate-ai-plugin-${VERSION}.tar.gz

# Install plugin
claude plugin install ./claude-real-estate-ai-plugin
\`\`\`
          " >> claude-real-estate-ai-plugin/INSTALL.md

      - name: Commit documentation updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add claude-real-estate-ai-plugin/README.md
          git add claude-real-estate-ai-plugin/INSTALL.md || true

          git diff --staged --quiet || git commit -m "docs: update installation instructions for ${{ github.ref_name }}"
          git push || echo "No changes to push"

  post-release-announcement:
    name: Post Release Announcement
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Generate announcement
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          cat > ANNOUNCEMENT.md << EOF
# ðŸŽ‰ Claude Real Estate AI Plugin ${VERSION} Released!

We're excited to announce the release of version ${VERSION} of the Claude Real Estate AI Plugin!

## ðŸ“¦ Download

Get the latest version from our [releases page](https://github.com/${{ github.repository }}/releases/tag/${VERSION}).

## ðŸš€ Installation

\`\`\`bash
# Download
wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/claude-real-estate-ai-plugin-${VERSION}.tar.gz

# Extract and install
tar -xzf claude-real-estate-ai-plugin-${VERSION}.tar.gz
claude plugin install ./claude-real-estate-ai-plugin
\`\`\`

## ðŸ“š Documentation

- [README](https://github.com/${{ github.repository }}/blob/main/claude-real-estate-ai-plugin/README.md)
- [Contributing Guide](https://github.com/${{ github.repository }}/blob/main/claude-real-estate-ai-plugin/CONTRIBUTING.md)
- [Changelog](https://github.com/${{ github.repository }}/releases/tag/${VERSION})

## ðŸ™ Thank You

Thanks to all contributors who made this release possible!

---

*Built with Claude Code for enterprise real estate automation*
EOF

          cat ANNOUNCEMENT.md

      - name: Create discussion
        run: |
          echo "âœ… Release announcement prepared"
          echo "   To create a discussion, visit:"
          echo "   https://github.com/${{ github.repository }}/discussions"

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs:
      - validate-release
      - build-package
      - generate-changelog
      - create-release
      - update-documentation
      - post-release-announcement
    if: always()
    steps:
      - name: Generate summary
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validation: ${{ needs.validate-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: ${{ needs.build-package.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Changelog: ${{ needs.generate-changelog.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation: ${{ needs.update-documentation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Announcement: ${{ needs.post-release-announcement.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download (tar.gz)](https://github.com/${{ github.repository }}/releases/download/$VERSION/claude-real-estate-ai-plugin-$VERSION.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download (zip)](https://github.com/${{ github.repository }}/releases/download/$VERSION/claude-real-estate-ai-plugin-$VERSION.zip)" >> $GITHUB_STEP_SUMMARY
