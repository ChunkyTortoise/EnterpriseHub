name: portal-api-phase1

on:
  pull_request:
    paths:
      - 'main.py'
      - 'portal_api/**'
      - 'modules/**'
      - '.github/workflows/portal-api-phase1.yml'
  push:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'portal_api/**'
      - 'modules/**'
      - '.github/workflows/portal-api-phase1.yml'

jobs:
  validate-portal-api-phase1:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: test
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fastapi==0.115.6 uvicorn==0.34.0 pydantic==2.10.6 python-dotenv==1.0.1 pytest==8.3.4 httpx==0.28.1 redis==5.2.1 ruff==0.9.9

      - name: Lint Phase 1 files
        run: |
          ruff check main.py portal_api modules

      - name: Compile checks
        run: |
          python -m py_compile \
            main.py \
            portal_api/app.py \
            portal_api/dependencies.py \
            portal_api/models.py \
            portal_api/routers/root.py \
            portal_api/routers/vapi.py \
            portal_api/routers/portal.py \
            portal_api/routers/ghl.py \
            portal_api/routers/admin.py \
            modules/inventory_manager.py \
            modules/ghl_sync.py \
            modules/appointment_manager.py \
            modules/voice_trigger.py

      - name: Run targeted tests
        run: |
          pytest -q -o addopts='' --confcutdir=portal_api/tests portal_api/tests

      - name: Interview flow smoke
        run: |
          set -euo pipefail

          python -m uvicorn main:app --host 127.0.0.1 --port 8000 >/tmp/portal-api.log 2>&1 &
          API_PID=$!

          cleanup() {
            kill "$API_PID" >/dev/null 2>&1 || true
            wait "$API_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in {1..40}; do
            status_code="$(curl -sS -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health 2>/dev/null || true)"
            if [[ "$status_code" == "200" ]]; then
              break
            fi
            sleep 0.25
            if [[ "$i" -eq 40 ]]; then
              echo "portal api failed to start"
              cat /tmp/portal-api.log
              exit 1
            fi
          done

          bash scripts/portal_api_interview_demo.sh
          python scripts/portal_api_client_example.py
