name: Plugin Validation

on:
  push:
    paths:
      - 'claude-real-estate-ai-plugin/**'
      - '.github/workflows/plugin-validation.yml'
  pull_request:
    paths:
      - 'claude-real-estate-ai-plugin/**'
  workflow_dispatch:

jobs:
  validate-plugin-manifest:
    name: Validate plugin.json
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install jsonschema pyyaml

      - name: Validate plugin.json structure
        run: |
          cat > validate_plugin.py << 'EOF'
          """Validate Claude Code plugin manifest."""
          import json
          import sys
          from pathlib import Path

          plugin_path = Path("claude-real-estate-ai-plugin/.claude-plugin/plugin.json")

          if not plugin_path.exists():
              print(f"❌ Plugin manifest not found at {plugin_path}")
              sys.exit(1)

          with open(plugin_path) as f:
              plugin = json.load(f)

          # Required fields
          required = ["name", "version", "description", "author"]
          for field in required:
              if field not in plugin:
                  print(f"❌ Missing required field: {field}")
                  sys.exit(1)

          # Validate version format (semver)
          version = plugin.get("version", "")
          parts = version.split(".")
          if len(parts) != 3 or not all(p.isdigit() for p in parts):
              print(f"❌ Invalid version format: {version} (expected semver x.y.z)")
              sys.exit(1)

          print(f"✅ Plugin manifest valid")
          print(f"   Name: {plugin['name']}")
          print(f"   Version: {plugin['version']}")
          print(f"   Author: {plugin['author']}")

          # Check optional sections
          if "skills" in plugin:
              print(f"   Skills: {len(plugin['skills'])} defined")
          if "hooks" in plugin:
              print(f"   Hooks: {len(plugin['hooks'])} defined")
          if "mcp_servers" in plugin:
              print(f"   MCP Servers: {len(plugin['mcp_servers'])} defined")
          EOF

          python validate_plugin.py

  skill-tests:
    name: Plugin Skills Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov pyyaml

      - name: Run skill tests
        run: |
          # Test each skill in the plugin
          PLUGIN_SKILLS="claude-real-estate-ai-plugin/skills"

          if [ -d "$PLUGIN_SKILLS" ]; then
            echo "Testing plugin skills..."
            find "$PLUGIN_SKILLS" -name "SKILL.md" | while read -r skill_file; do
              skill_dir=$(dirname "$skill_file")
              skill_name=$(basename "$skill_dir")
              echo "✅ Found skill: $skill_name"

              # Validate SKILL.md has required frontmatter
              if ! grep -q "^---" "$skill_file"; then
                echo "❌ Missing YAML frontmatter in $skill_file"
                exit 1
              fi
            done
          else
            echo "⚠️  No plugin skills directory found"
          fi

  hook-tests:
    name: Plugin Hooks Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Validate hook scripts
        run: |
          PLUGIN_HOOKS="claude-real-estate-ai-plugin/hooks"

          if [ -d "$PLUGIN_HOOKS" ]; then
            echo "Validating plugin hooks..."
            find "$PLUGIN_HOOKS" -name "*.sh" -type f | while read -r hook; do
              echo "Checking: $hook"
              shellcheck "$hook" -e SC1090,SC1091 || exit 1
            done

            find "$PLUGIN_HOOKS" -name "*.yaml" -type f | while read -r hook; do
              echo "Validating: $hook"
              python -c "import yaml; yaml.safe_load(open('$hook'))" || exit 1
            done
          else
            echo "⚠️  No plugin hooks directory found"
          fi

  mcp-integration-tests:
    name: MCP Server Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test MCP server configurations
        run: |
          PLUGIN_MCP="claude-real-estate-ai-plugin/mcp-profiles"

          if [ -d "$PLUGIN_MCP" ]; then
            echo "Validating MCP profiles..."
            find "$PLUGIN_MCP" -name "*.json" -type f | while read -r profile; do
              echo "Validating: $profile"
              python -c "import json; json.load(open('$profile'))" || exit 1
              echo "✅ Valid JSON: $profile"
            done
          else
            echo "⚠️  No MCP profiles found"
          fi

  documentation-check:
    name: Plugin Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          PLUGIN_DIR="claude-real-estate-ai-plugin"

          required_docs=(
            "README.md"
            "STRUCTURE.md"
            "CONTRIBUTING.md"
            "LICENSE"
          )

          for doc in "${required_docs[@]}"; do
            if [ -f "$PLUGIN_DIR/$doc" ]; then
              echo "✅ Found: $doc"
            else
              echo "❌ Missing: $doc"
              exit 1
            fi
          done

      - name: Validate README completeness
        run: |
          README="claude-real-estate-ai-plugin/README.md"

          required_sections=(
            "Installation"
            "Features"
            "Usage"
            "Skills"
            "Configuration"
          )

          for section in "${required_sections[@]}"; do
            if grep -qi "$section" "$README"; then
              echo "✅ Found section: $section"
            else
              echo "⚠️  Missing recommended section: $section"
            fi
          done

  integration-test-suite:
    name: Full Plugin Integration
    runs-on: ubuntu-latest
    needs: [validate-plugin-manifest, skill-tests, hook-tests, mcp-integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install plugin locally
        run: |
          # Simulate plugin installation
          echo "Testing plugin installation..."

          PLUGIN_DIR="claude-real-estate-ai-plugin"

          # Check plugin structure
          dirs=("skills" "hooks" "agents" "mcp-profiles" "scripts")
          for dir in "${dirs[@]}"; do
            if [ -d "$PLUGIN_DIR/$dir" ]; then
              echo "✅ Found directory: $dir"
            fi
          done

      - name: Test plugin health
        run: |
          cat > test_plugin_health.py << 'EOF'
          """Test plugin health and completeness."""
          import json
          from pathlib import Path

          plugin_dir = Path("claude-real-estate-ai-plugin")
          plugin_json = plugin_dir / ".claude-plugin" / "plugin.json"

          with open(plugin_json) as f:
              plugin = json.load(f)

          print(f"✅ Plugin: {plugin['name']} v{plugin['version']}")

          # Count components
          skills_dir = plugin_dir / "skills"
          if skills_dir.exists():
              skills = list(skills_dir.glob("**/SKILL.md"))
              print(f"   Skills: {len(skills)}")

          hooks_dir = plugin_dir / "hooks"
          if hooks_dir.exists():
              hooks = list(hooks_dir.glob("*.sh")) + list(hooks_dir.glob("*.md"))
              print(f"   Hooks: {len(hooks)}")

          agents_dir = plugin_dir / "agents"
          if agents_dir.exists():
              agents = list(agents_dir.glob("*.md"))
              print(f"   Agents: {len(agents)}")

          print("\n✅ Plugin health check passed")
          EOF

          python test_plugin_health.py

  summary:
    name: Plugin Validation Summary
    runs-on: ubuntu-latest
    needs:
      - validate-plugin-manifest
      - skill-tests
      - hook-tests
      - mcp-integration-tests
      - documentation-check
      - integration-test-suite
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Plugin Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Manifest: ${{ needs.validate-plugin-manifest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Skills: ${{ needs.skill-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Hooks: ${{ needs.hook-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP: ${{ needs.mcp-integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docs: ${{ needs.documentation-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Integration: ${{ needs.integration-test-suite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Plugin Health" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks completed successfully!" >> $GITHUB_STEP_SUMMARY
