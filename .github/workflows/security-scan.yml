name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - '**/*.py'
      - 'requirements*.txt'
      - 'docker-compose*.yml'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Scan for hardcoded credentials
        run: |
          # Scan Python source for potential secrets
          # - Require 20+ char values (skips enum labels like "ultra_secret", "access_token")
          # - Exclude tests, archives, vendor code, scripts
          FOUND=0
          if grep -r -E "(API_KEY|SECRET|PASSWORD|TOKEN)\s*=\s*['\"][^'\"]{20,}['\"]" \
              --include="*.py" \
              --exclude-dir=.git \
              --exclude-dir=_archive \
              --exclude-dir=auto-claude \
              --exclude-dir=tests \
              --exclude-dir=scripts \
              --exclude-dir=__pycache__ \
              --exclude-dir=venv \
              --exclude-dir=.claude \
              . | grep -v "\.example" | grep -v "test_" | grep -v "your_.*_here" | grep -v '""' | grep -v "None"; then
            FOUND=1
          fi

          # Check for actual secret values (quoted keys with 20+ random chars)
          # Excludes validation code like startswith('sk-ant-') and format references
          if grep -r -E "['\"]sk-ant-[a-zA-Z0-9-]{20,}['\"]" \
              --include="*.py" \
              --exclude-dir=.git \
              --exclude-dir=_archive \
              --exclude-dir=auto-claude \
              --exclude-dir=tests \
              --exclude-dir=scripts \
              . | grep -v "startswith\|format\|example\|demo\|placeholder\|your_"; then
            FOUND=1
          fi

          if grep -r -E "(AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36})" \
              --include="*.py" \
              --exclude-dir=.git \
              --exclude-dir=_archive \
              --exclude-dir=auto-claude \
              --exclude-dir=tests \
              --exclude-dir=scripts \
              .; then
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Potential secrets detected in source code"
            exit 1
          fi

          echo "No secrets detected"

  python-security:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Run Bandit
        run: |
          pip install bandit[toml]
          bandit -r ghl_real_estate_ai/ -f json -o bandit-report.json \
            -s B101 \
            --exclude "*/tests/*" || true
          # Text summary (non-blocking — report artifact has full details)
          bandit -r ghl_real_estate_ai/ -s B101 --exclude "*/tests/*" \
            -ll || true  # Only show MEDIUM+ severity

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Audit Python dependencies
        run: |
          pip install pip-audit
          pip install -r requirements.txt
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit || echo "Vulnerabilities found — review required"

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit
          path: pip-audit-report.json

  sql-injection-check:
    name: SQL Injection Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Check for SQL injection patterns
        run: |
          echo "Scanning for SQL injection patterns..."
          FOUND=0

          # String formatting in execute()
          if grep -rn 'execute([^)]*%' ghl_real_estate_ai/ --include="*.py" \
              --exclude-dir=__pycache__ | grep -v test_; then
            echo "::warning::String formatting in execute() calls found"
            FOUND=1
          fi

          # .format() piped to execute
          if grep -rn '\.format(.*execute' ghl_real_estate_ai/ --include="*.py" \
              --exclude-dir=__pycache__ | grep -v test_; then
            echo "::warning::format() with execute() found"
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Potential SQL injection patterns detected"
            exit 1
          fi

          echo "No SQL injection patterns detected"

  infrastructure-security:
    name: Infrastructure Config Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Scan Docker Compose for security issues
        run: |
          pip install checkov
          for f in docker-compose*.yml; do
            if [ -f "$f" ]; then
              echo "Scanning $f..."
              checkov -f "$f" --framework docker_compose --soft-fail || true
            fi
          done

      - name: Check for secrets in infrastructure files
        run: |
          FOUND=0
          if grep -r -i "password.*=.*['\"][^'\"]\{8,\}['\"]" docker-compose*.yml infrastructure/ \
              --exclude="*.example" 2>/dev/null | grep -v "password_file\|password_hash\|_PASSWORD:"; then
            echo "Potential hardcoded passwords in infrastructure files"
            FOUND=1
          fi

          if [ "$FOUND" -eq 0 ]; then
            echo "No secrets found in infrastructure files"
          fi

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Fair housing compliance
        run: |
          # Check for demographic filtering in business logic (not test files)
          if grep -r -i -l "race\|religion\|gender\|nationality\|ethnicity" \
              ghl_real_estate_ai/ --include="*.py" \
              | grep -v test | grep -v __pycache__; then
            echo "Review flagged files for fair housing compliance"
          else
            echo "No demographic filtering patterns found"
          fi

      - name: Verify .env is gitignored
        run: |
          if grep -q "^\.env$" .gitignore; then
            echo ".env is properly gitignored"
          else
            echo "::error::.env is not in .gitignore"
            exit 1
          fi

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - secrets-detection
      - python-security
      - dependency-audit
      - sql-injection-check
      - infrastructure-security
      - compliance-check
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | ${{ needs.secrets-detection.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis (Bandit) | ${{ needs.python-security.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Injection | ${{ needs.sql-injection-check.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Config | ${{ needs.infrastructure-security.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compliance | ${{ needs.compliance-check.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY

          TOTAL=6
          PASSED=0
          [ "${{ needs.secrets-detection.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.python-security.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.dependency-audit.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.sql-injection-check.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.infrastructure-security.result }}" == "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.compliance-check.result }}" == "success" ] && PASSED=$((PASSED + 1))

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score: ${PASSED}/${TOTAL}**" >> $GITHUB_STEP_SUMMARY
