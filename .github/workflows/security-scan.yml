name: Security Scan Pipeline
# Comprehensive security scanning for EnterpriseHub production deployment

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secret-detection:
    name: Secret Detection Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: GitLeaks Secret Detection
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}

  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Safety check
      run: |
        pip install safety
        safety check --json --output safety_report.json || true

    - name: Run pip-audit
      run: |
        pip install pip-audit
        pip-audit --desc --output=json --output-file=pip_audit_report.json || true

    - name: Run Bandit security linter
      run: |
        pip install bandit
        bandit -r ghl_real_estate_ai/ -f json -o bandit_report.json || true

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety_report.json
          pip_audit_report.json
          bandit_report.json

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker images
      run: |
        docker-compose -f docker-compose.production.yml build

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'enterprisehub:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Hadolint for Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: docker/Dockerfile.*
        format: sarif
        output-file: hadolint-results.sarif
        no-fail: true

  infrastructure-security:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Checkov
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: dockerfile,docker_compose,secrets
        output_format: sarif
        output_file_path: checkov_report.sarif

    - name: Terraform Security Scan (if applicable)
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: '.'
        format: sarif
        soft_fail: true

    - name: Upload infrastructure scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov_report.sarif

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/python

  ssl-tls-security:
    name: SSL/TLS Configuration Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate SSL Configuration
      run: |
        # Check NGINX SSL configuration
        docker run --rm -v $(pwd)/nginx.conf:/etc/nginx/nginx.conf nginx:alpine nginx -t

        # Extract SSL settings for security review
        grep -i ssl nginx.conf > ssl_config_review.txt || true
        echo "SSL Configuration extracted for review"

    - name: SSL Labs Test Simulation
      run: |
        # Simulate SSL configuration testing
        python3 -c "
        import ssl
        import socket

        # Test supported TLS versions and ciphers
        context = ssl.create_default_context()
        print('Default SSL context created successfully')
        print('Supported ciphers:', len(context.get_ciphers()))
        print('Protocol options:', context.protocol)
        "

  environment-security:
    name: Environment Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check environment file templates
      run: |
        # Verify no secrets in environment templates
        if grep -r "CHANGE_ME_" .env.production.template; then
          echo "Environment template contains placeholder values - GOOD"
        else
          echo "Warning: Environment template may contain hardcoded values"
          exit 1
        fi

    - name: Docker Compose Security Check
      run: |
        # Check for hardcoded secrets in docker-compose files
        if grep -i "password.*=" docker-compose.production.yml | grep -v '\${'; then
          echo "ERROR: Hardcoded passwords found in Docker Compose!"
          exit 1
        else
          echo "No hardcoded passwords found - GOOD"
        fi

  security-report:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [secret-detection, dependency-security, container-security, infrastructure-security, code-security, ssl-tls-security, environment-security]
    if: always()

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: ./reports

    - name: Generate Security Summary
      run: |
        echo "# Security Scan Summary" > security_summary.md
        echo "Date: $(date)" >> security_summary.md
        echo "" >> security_summary.md

        echo "## Scan Results:" >> security_summary.md
        echo "- Secret Detection: ${{ needs.secret-detection.result }}" >> security_summary.md
        echo "- Dependency Security: ${{ needs.dependency-security.result }}" >> security_summary.md
        echo "- Container Security: ${{ needs.container-security.result }}" >> security_summary.md
        echo "- Infrastructure Security: ${{ needs.infrastructure-security.result }}" >> security_summary.md
        echo "- Code Security: ${{ needs.code-security.result }}" >> security_summary.md
        echo "- SSL/TLS Security: ${{ needs.ssl-tls-security.result }}" >> security_summary.md
        echo "- Environment Security: ${{ needs.environment-security.result }}" >> security_summary.md

        echo "" >> security_summary.md
        echo "## Next Actions:" >> security_summary.md
        echo "- Review all SARIF reports in Security tab" >> security_summary.md
        echo "- Address any HIGH/CRITICAL vulnerabilities immediately" >> security_summary.md
        echo "- Update dependencies with known vulnerabilities" >> security_summary.md
        echo "- Rotate any exposed secrets" >> security_summary.md

        cat security_summary.md

    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security_summary.md

    - name: Comment on PR (if applicable)
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('security_summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [secret-detection, dependency-security, container-security, infrastructure-security, environment-security]

    steps:
    - name: Evaluate Security Results
      run: |
        # Fail the pipeline if critical security issues found
        echo "Evaluating security scan results..."

        # Check if any critical jobs failed
        if [[ "${{ needs.secret-detection.result }}" == "failure" ]]; then
          echo "CRITICAL: Secret detection found exposed secrets!"
          exit 1
        fi

        if [[ "${{ needs.environment-security.result }}" == "failure" ]]; then
          echo "CRITICAL: Environment security check failed!"
          exit 1
        fi

        echo "Security quality gate passed âœ“"