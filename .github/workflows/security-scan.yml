name: ðŸ”’ Jorge Platform - Enhanced Security Scanning

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.tsx'
      - 'requirements*.txt'
      - 'package*.json'
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'infrastructure/**'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC for enhanced monitoring
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secrets scan

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Scan for secrets
        run: |
          # Create baseline if doesn't exist
          if [ ! -f ".secrets.baseline" ]; then
            detect-secrets scan --baseline .secrets.baseline
          fi

          # Scan current state
          detect-secrets scan --baseline .secrets.baseline --exclude-files '\.git/.*' --exclude-files 'node_modules/.*'

          echo "âœ… No secrets detected"

      - name: Check for hardcoded credentials
        run: |
          cat > check_credentials.py << 'EOF'
          """Check for hardcoded credentials patterns."""
          import re
          import sys
          from pathlib import Path

          # Patterns to detect
          patterns = [
              (r'password\s*=\s*["\'][^"\']+["\']', "Hardcoded password"),
              (r'api[_-]?key\s*=\s*["\'][^"\']+["\']', "Hardcoded API key"),
              (r'secret\s*=\s*["\'][^"\']+["\']', "Hardcoded secret"),
              (r'token\s*=\s*["\'][^"\']+["\']', "Hardcoded token"),
              (r'AKIA[0-9A-Z]{16}', "AWS Access Key"),
              (r'sk-[a-zA-Z0-9]{48}', "OpenAI API Key"),
          ]

          # Exclude patterns (valid usage)
          exclude_patterns = [
              r'password\s*=\s*""',  # Empty string
              r'password\s*=\s*None',  # None value
              r'password\s*=\s*get',  # Getting from env
              r'\.example',  # Example files
              r'test_',  # Test files
          ]

          def should_check_file(path):
              """Check if file should be scanned."""
              exclude_dirs = {'node_modules', '.git', '__pycache__', '.pytest_cache', 'venv'}
              exclude_files = {'.env.example', 'test_'}

              if any(ex in str(path) for ex in exclude_dirs):
                  return False
              if any(ex in path.name for ex in exclude_files):
                  return False
              return True

          issues = []
          for py_file in Path('.').rglob('*.py'):
              if not should_check_file(py_file):
                  continue

              try:
                  content = py_file.read_text()
                  for pattern, desc in patterns:
                      for match in re.finditer(pattern, content, re.IGNORECASE):
                          # Check if it's excluded
                          matched_text = match.group(0)
                          if not any(re.search(ex, matched_text) for ex in exclude_patterns):
                              issues.append(f"{py_file}:{desc} - {matched_text[:50]}")
              except Exception as e:
                  print(f"Warning: Could not read {py_file}: {e}")

          if issues:
              print("âŒ Potential hardcoded credentials found:")
              for issue in issues:
                  print(f"  - {issue}")
              sys.exit(1)
          else:
              print("âœ… No hardcoded credentials detected")
          EOF

          python check_credentials.py

  python-security:
    name: Python Security (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Bandit
        run: |
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          # Create bandit config if doesn't exist
          cat > .bandit << 'EOF'
          [bandit]
          exclude_dirs = [
              "/tests/",
              "/.venv/",
              "/venv/",
              "/__pycache__/",
              "/.pytest_cache/",
              "/node_modules/"
          ]
          skips = ["B101", "B601"]
          EOF

          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Safety
        run: |
          pip install safety

      - name: Audit Python dependencies
        run: |
          # Install dependencies first
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

          # Run safety check
          safety check --json --output safety-report.json || true
          safety check || echo "âš ï¸  Vulnerabilities found, review required"

      - name: Check for outdated dependencies
        run: |
          pip list --outdated --format=json > outdated-deps.json
          cat outdated-deps.json

      - name: Upload dependency audit
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit
          path: |
            safety-report.json
            outdated-deps.json

  code-quality:
    name: Code Quality & Vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install quality tools
        run: |
          pip install pylint radon

      - name: Check cyclomatic complexity
        run: |
          cat > check_complexity.py << 'EOF'
          """Check code complexity."""
          import subprocess
          import json

          # Run radon for complexity
          result = subprocess.run(
              ['radon', 'cc', '.', '-j', '--min', 'C'],
              capture_output=True,
              text=True
          )

          if result.stdout:
              data = json.loads(result.stdout)
              if data:
                  print("âš ï¸  High complexity functions found:")
                  for file, items in data.items():
                      for item in items:
                          if item.get('complexity', 0) > 10:
                              print(f"  {file}:{item['name']} - Complexity: {item['complexity']}")
              else:
                  print("âœ… No high complexity functions")
          EOF

          python check_complexity.py || true

  sql-injection-check:
    name: SQL Injection Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for SQL injection vulnerabilities
        run: |
          cat > check_sql.py << 'EOF'
          """Check for potential SQL injection vulnerabilities."""
          import re
          from pathlib import Path

          dangerous_patterns = [
              r'execute\([^)]*%[^)]*\)',  # String formatting in execute
              r'\.format\([^)]*\).*execute',  # format() with execute
              r'f["\'].*\{.*\}.*["\'].*execute',  # f-string with execute
          ]

          issues = []
          for py_file in Path('.').rglob('*.py'):
              if 'test_' in py_file.name or '__pycache__' in str(py_file):
                  continue

              try:
                  content = py_file.read_text()
                  for pattern in dangerous_patterns:
                      matches = re.finditer(pattern, content, re.IGNORECASE)
                      for match in matches:
                          issues.append(f"{py_file}: Potential SQL injection - {match.group(0)[:60]}")
              except Exception:
                  pass

          if issues:
              print("âš ï¸  Potential SQL injection vulnerabilities:")
              for issue in issues:
                  print(f"  - {issue}")
          else:
              print("âœ… No SQL injection patterns detected")
          EOF

          python check_sql.py

  frontend-security:
    name: Frontend Security (Node.js)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./enterprise-ui
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: enterprise-ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ðŸ›¡ï¸ Scanning Node.js dependencies for vulnerabilities..."
          npm audit --audit-level moderate --json > npm-audit-report.json || true
          npm audit --audit-level moderate || echo "âš ï¸ Vulnerabilities found in frontend dependencies"

      - name: Run ESLint with security rules
        run: |
          echo "ðŸ” Running ESLint with security focus..."
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-security-report.json || true
          npx eslint . --ext .js,.jsx,.ts,.tsx || echo "âš ï¸ ESLint security issues found"

      - name: Check for XSS vulnerabilities
        run: |
          echo "ðŸ” Scanning for potential XSS vulnerabilities..."

          # Check for dangerous innerHTML usage
          if grep -r "innerHTML\|dangerouslySetInnerHTML" src/ --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js"; then
            echo "âš ï¸ Potential XSS risk: innerHTML usage found"
          fi

          # Check for unescaped user input
          if grep -r "document\.write\|eval(" src/ --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js"; then
            echo "âš ï¸ Potential XSS risk: Dangerous functions found"
          fi

          echo "âœ… XSS vulnerability scan completed"

      - name: Upload frontend security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-security-reports
          path: |
            enterprise-ui/npm-audit-report.json
            enterprise-ui/eslint-security-report.json

  docker-security:
    name: Docker Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images for security scanning
        run: |
          echo "ðŸ—ï¸ Building Docker images for security analysis..."
          docker build -f Dockerfile.api -t jorge-backend:security-scan .
          docker build -f Dockerfile.worker -t jorge-worker:security-scan .

      - name: Run Trivy vulnerability scanner on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'jorge-backend:security-scan'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner on worker
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'jorge-worker:security-scan'
          format: 'sarif'
          output: 'trivy-worker-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'

      - name: Upload worker Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-worker-results.sarif'

      - name: Docker best practices scan
        run: |
          echo "ðŸ” Checking Docker best practices..."

          # Check for root user usage
          if grep -r "USER root\|USER 0" Dockerfile*; then
            echo "âš ï¸ Root user found in Dockerfile - security risk"
          fi

          # Check for latest tags
          if grep -r ":latest" Dockerfile*; then
            echo "âš ï¸ Latest tags found - use specific versions for security"
          fi

          # Check for ADD vs COPY
          if grep -r "^ADD " Dockerfile*; then
            echo "âš ï¸ ADD instruction found - prefer COPY for security"
          fi

          echo "âœ… Docker best practices scan completed"

  infrastructure-security:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install security scanning tools
        run: |
          # Install checkov for infrastructure scanning
          pip install checkov

      - name: Scan Docker Compose configurations
        run: |
          echo "ðŸ” Scanning Docker Compose files for security issues..."

          if [ -f "docker-compose.yml" ]; then
            checkov -f docker-compose.yml --framework docker_compose --output json --output-file docker-compose-security.json || true
            checkov -f docker-compose.yml --framework docker_compose || echo "âš ï¸ Security issues found in docker-compose.yml"
          fi

          if [ -f "docker-compose.scale.yml" ]; then
            checkov -f docker-compose.scale.yml --framework docker_compose --output json --output-file docker-compose-scale-security.json || true
            checkov -f docker-compose.scale.yml --framework docker_compose || echo "âš ï¸ Security issues found in docker-compose.scale.yml"
          fi

      - name: Scan Kubernetes manifests
        run: |
          echo "ðŸ” Scanning Kubernetes manifests for security issues..."

          if [ -d "infrastructure/kubernetes" ]; then
            checkov -d infrastructure/kubernetes --framework kubernetes --output json --output-file k8s-security.json || true
            checkov -d infrastructure/kubernetes --framework kubernetes || echo "âš ï¸ Security issues found in K8s manifests"
          fi

      - name: Check for secrets in infrastructure files
        run: |
          echo "ðŸ” Scanning infrastructure files for potential secrets..."

          # Check for hardcoded passwords in configs
          if grep -r -i "password.*=" infrastructure/ docker-compose*.yml --exclude="*.example" | grep -v "password_file\|password_hash"; then
            echo "âš ï¸ Potential hardcoded passwords found in infrastructure files"
          fi

          # Check for API keys
          if grep -r -i "api.key.*=" infrastructure/ docker-compose*.yml --exclude="*.example"; then
            echo "âš ï¸ Potential API keys found in infrastructure files"
          fi

          echo "âœ… Infrastructure secrets scan completed"

      - name: Upload infrastructure security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: infrastructure-security-reports
          path: |
            docker-compose-security.json
            docker-compose-scale-security.json
            k8s-security.json

  compliance-check:
    name: Compliance & Regulatory Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: GDPR compliance check
        run: |
          echo "ðŸ” Checking GDPR compliance requirements..."

          # Check for data processing consent
          if ! grep -r "consent\|opt.*in\|data.*agreement" ghl_real_estate_ai/ enterprise-ui/ --include="*.py" --include="*.tsx" --include="*.ts"; then
            echo "âš ï¸ No consent mechanisms found - potential GDPR violation"
          fi

          # Check for data retention policies
          if ! grep -r "retention\|delete.*after\|expiry\|ttl" ghl_real_estate_ai/ --include="*.py"; then
            echo "âš ï¸ No data retention policies found"
          fi

          # Check for data encryption
          if ! grep -r "encrypt\|bcrypt\|hash" ghl_real_estate_ai/ --include="*.py"; then
            echo "âš ï¸ No encryption mechanisms found"
          fi

          echo "âœ… GDPR compliance check completed"

      - name: Real estate industry compliance
        run: |
          echo "ðŸ” Checking real estate industry compliance..."

          # Check for fair housing compliance
          if grep -r -i "race\|religion\|gender\|nationality\|ethnicity" ghl_real_estate_ai/ --include="*.py" | grep -v "test\|example"; then
            echo "âš ï¸ Potential fair housing violation - demographic filtering detected"
          fi

          # Check for data privacy in property records
          if grep -r -i "ssn\|social.*security\|credit.*score" ghl_real_estate_ai/ --include="*.py" | grep -v "test\|example"; then
            echo "âš ï¸ Sensitive financial data handling detected - ensure compliance"
          fi

          echo "âœ… Real estate compliance check completed"

  summary:
    name: ðŸ“Š Enhanced Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - secrets-detection
      - python-security
      - dependency-audit
      - code-quality
      - sql-injection-check
      - frontend-security
      - docker-security
      - infrastructure-security
      - compliance-check
    if: always()

    steps:
      - name: Download all security reports
        uses: actions/download-artifact@v4

      - name: Generate comprehensive security summary
        run: |
          echo "# ðŸ”’ Jorge Platform - Comprehensive Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ›¡ï¸ Backend Security" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Secrets Detection | ${{ needs.secrets-detection.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Scans for hardcoded secrets and credentials |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Python Security (Bandit) | ${{ needs.python-security.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Static analysis for security vulnerabilities |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependency Audit | ${{ needs.dependency-audit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Known vulnerabilities in Python packages |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’‰ SQL Injection Check | ${{ needs.sql-injection-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Database security patterns |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸŽ¯ Frontend Security" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Node.js Dependencies | ${{ needs.frontend-security.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | npm audit for vulnerable packages |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ XSS Prevention | ${{ needs.frontend-security.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Cross-site scripting vulnerability scan |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ³ Infrastructure Security" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Security | ${{ needs.docker-security.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Container image vulnerability scanning |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Infrastructure Config | ${{ needs.infrastructure-security.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | K8s, Docker Compose security best practices |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“‹ Compliance & Governance" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Complexity and maintainability analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ GDPR Compliance | ${{ needs.compliance-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Data protection and privacy compliance |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ  Real Estate Compliance | ${{ needs.compliance-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Fair housing and industry regulations |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate overall security score
          TOTAL_CHECKS=9
          PASSED_CHECKS=0

          [ "${{ needs.secrets-detection.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.python-security.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.dependency-audit.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.code-quality.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.sql-injection-check.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.frontend-security.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.docker-security.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.infrastructure-security.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))
          [ "${{ needs.compliance-check.result }}" == "success" ] && PASSED_CHECKS=$((PASSED_CHECKS + 1))

          SCORE=$((PASSED_CHECKS * 100 / TOTAL_CHECKS))

          echo "## ðŸŽ¯ Overall Security Score: ${SCORE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $SCORE -eq 100 ]; then
            echo "## âœ… **EXCELLENT SECURITY POSTURE**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All security checks passed!** Jorge's Real Estate AI Platform is ready for production deployment with enterprise-grade security." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Ready for:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Production deployment" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Client demonstrations" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Enterprise sales" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Regulatory compliance audits" >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 80 ]; then
            echo "## âš ï¸ **GOOD SECURITY POSTURE - MINOR ISSUES**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Most security checks passed. Review and fix remaining issues before production deployment." >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 60 ]; then
            echo "## ðŸ”¶ **MODERATE SECURITY ISSUES - ATTENTION NEEDED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Several security issues detected. Address these before proceeding to production." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ **SIGNIFICANT SECURITY ISSUES - IMMEDIATE ACTION REQUIRED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Critical security issues detected. Do not deploy to production until these are resolved." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Detailed Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend security reports (Bandit, Safety, complexity)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend security reports (npm audit, ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure security reports (Docker, K8s, Checkov)" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF reports uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY

      - name: Set deployment gate status
        run: |
          # Set output for downstream CI/CD pipeline
          if [ "${{ needs.secrets-detection.result }}" == "success" ] && \
             [ "${{ needs.python-security.result }}" == "success" ] && \
             [ "${{ needs.dependency-audit.result }}" == "success" ] && \
             [ "${{ needs.frontend-security.result }}" == "success" ] && \
             [ "${{ needs.docker-security.result }}" == "success" ]; then
            echo "SECURITY_GATE_PASSED=true" >> $GITHUB_OUTPUT
            echo "ðŸŸ¢ Security gate PASSED - Safe for production deployment"
          else
            echo "SECURITY_GATE_PASSED=false" >> $GITHUB_OUTPUT
            echo "ðŸ”´ Security gate FAILED - Do not deploy to production"
            exit 1
          fi
