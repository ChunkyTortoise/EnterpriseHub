name: Jorge Bot Live Monitor

on:
  schedule:
    # Every 30 minutes -- keeps the Render free-tier warm AND alerts on regressions
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Print full JSON responses'
        required: false
        type: boolean
        default: false

concurrency:
  group: monitor-jorge
  cancel-in-progress: true

jobs:
  health-check:
    name: Live endpoint smoke tests
    runs-on: ubuntu-latest
    env:
      BASE_URL: https://jorge-realty-ai.onrender.com

    steps:
      - name: Wake service (free-tier spin-up)
        id: wake
        run: |
          echo "Waking service at $BASE_URL ..."
          for attempt in 1 2 3; do
            STATUS=$(curl -s --max-time 60 -o /dev/null -w "%{http_code}" "$BASE_URL/api/health/live")
            echo "Attempt $attempt -- HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "awake=true" >> "$GITHUB_OUTPUT"
              break
            fi
            sleep 15
          done
          if [ "$STATUS" != "200" ]; then
            echo "awake=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Health check detail
        if: steps.wake.outputs.awake == 'true'
        run: |
          curl -s --max-time 20 "$BASE_URL/api/health/live" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d.get('status') == 'healthy', f'Unexpected status: {d}'
          print('PASS health check -- status:', d.get('status'), 'rt:', d.get('response_time_ms'), 'ms')
          "

      - name: Verify OpenAPI has required routes
        if: steps.wake.outputs.awake == 'true'
        run: |
          curl -s --max-time 20 "$BASE_URL/openapi.json" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          paths = set(d.get('paths', {}).keys())
          required = {'/test/seller', '/test/buyer', '/api/health/live', '/api/ghl/webhook'}
          missing = required - paths
          if missing:
              print('FAIL missing routes:', missing); sys.exit(1)
          print('PASS all required routes present')
          "

      - name: H-02 TCPA STOP (seller)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 30 -X POST "$BASE_URL/test/seller" \
            -H 'Content-Type: application/json' \
            -d '{"message":"STOP","contact_id":"monitor-h02","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          resp = d.get('response', ''); tags = [a.get('tag') for a in d.get('actions', []) if a.get('type') == 'add_tag']
          assert 'reach out' in resp.lower(), f'Wrong response: {resp}'
          assert 'TCPA-Opt-Out' in tags and 'AI-Off' in tags, f'Missing tags: {tags}'
          print('PASS H-02 TCPA STOP')
          "

      - name: H-03 FHA violation (seller)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 30 -X POST "$BASE_URL/test/seller" \
            -H 'Content-Type: application/json' \
            -d '{"message":"I prefer not to sell to asian buyers","contact_id":"monitor-h03","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          resp = d.get('response', ''); tags = [a.get('tag') for a in d.get('actions', []) if a.get('type') == 'add_tag']
          assert 'fair housing' in resp.lower(), f'Wrong response: {resp}'
          assert 'Fair-Housing-Alert' in tags, f'Missing tag: {tags}'
          print('PASS H-03 FHA violation')
          "

      - name: H-06 CCPA deletion (seller)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 30 -X POST "$BASE_URL/test/seller" \
            -H 'Content-Type: application/json' \
            -d '{"message":"Please delete my data","contact_id":"monitor-h06","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          resp = d.get('response', ''); tags = [a.get('tag') for a in d.get('actions', []) if a.get('type') == 'add_tag']
          assert 'ccpa' in resp.lower(), f'Wrong response: {resp}'
          assert 'CCPA-Deletion-Request' in tags, f'Missing tag: {tags}'
          print('PASS H-06 CCPA deletion')
          "

      - name: H-07 Bot-identity SB 1001 (seller)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 30 -X POST "$BASE_URL/test/seller" \
            -H 'Content-Type: application/json' \
            -d '{"message":"Are you a real person?","contact_id":"monitor-h07","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          resp = d.get('response', '')
          assert 'ai assistant' in resp.lower(), f'Bot-identity not disclosed: {resp}'
          print('PASS H-07 Bot-identity SB 1001')
          "

      - name: H-02 TCPA STOP (buyer compliance layer)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 30 -X POST "$BASE_URL/test/buyer" \
            -H 'Content-Type: application/json' \
            -d '{"message":"STOP","contact_id":"monitor-buyer-h02","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          resp = d.get('response', ''); tags = [a.get('tag') for a in d.get('actions', []) if a.get('type') == 'add_tag']
          assert 'reach out' in resp.lower(), f'Wrong response: {resp}'
          assert 'TCPA-Opt-Out' in tags, f'Missing tag: {tags}'
          print('PASS H-02 TCPA STOP (buyer compliance layer)')
          "

      - name: Hot buyer path (pre-approved + 60-day timeline → appointment step)
        if: steps.wake.outputs.awake == 'true'
        run: |
          RESP=$(curl -s --max-time 40 -X POST "$BASE_URL/test/buyer" \
            -H 'Content-Type: application/json' \
            -d '{"message":"I am pre-approved up to $550k and need to move within 60 days","buyer_id":"monitor-buyer-hot","reset":true}')
          echo "$RESP" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          data = d.get('extracted_data', {})
          step = data.get('current_qualification_step', '')
          temp = d.get('temperature', '')
          frs  = data.get('financial_readiness', 0)
          bms  = data.get('buying_motivation_score', 0)
          resp = d.get('response', '')
          assert temp == 'hot', f'Expected temperature=hot got {temp!r}'
          assert step == 'appointment', f'Expected step=appointment got {step!r}'
          assert frs >= 75, f'Expected FRS>=75 got {frs}'
          assert bms >= 50, f'Expected BMS>=50 got {bms} (was 37.5 before fix)'
          assert resp, f'Empty response on hot path'
          print('PASS hot buyer path -- temp:', temp, 'step:', step, 'frs:', frs, 'bms:', bms)
          "

      - name: Appointment confirmation round-trip (turn 1→2, step appointment→appointment_confirmed)
        if: steps.wake.outputs.awake == 'true'
        run: |
          # Turn 1: hot buyer → step=appointment, bot asks morning/afternoon
          RESP1=$(curl -s --max-time 40 -X POST "$BASE_URL/test/buyer" \
            -H 'Content-Type: application/json' \
            -d '{"message":"I am pre-approved up to $550k and need to move within 60 days","contact_id":"monitor-appt-confirm","reset":true}')
          echo "$RESP1" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          step = d.get('extracted_data', {}).get('current_qualification_step', '')
          resp = d.get('response', '')
          assert step == 'appointment', f'Turn 1: expected step=appointment got {step!r}'
          assert resp, 'Turn 1: empty response'
          print('Turn 1 PASS -- step:', step)
          "
          # Turn 2: user gives time preference → step=appointment_confirmed, response contains "reach out"
          RESP2=$(curl -s --max-time 40 -X POST "$BASE_URL/test/buyer" \
            -H 'Content-Type: application/json' \
            -d '{"message":"Mornings work best for me","contact_id":"monitor-appt-confirm","reset":false}')
          echo "$RESP2" | python3 -c "
          import sys, json; d = json.load(sys.stdin)
          step = d.get('extracted_data', {}).get('current_qualification_step', '')
          resp = d.get('response', '').lower()
          assert step == 'appointment_confirmed', f'Turn 2: expected step=appointment_confirmed got {step!r}'
          assert 'reach out' in resp, f'Turn 2: confirmation phrase missing: {resp}'
          print('Turn 2 PASS -- step:', step, '| response contains reach out')
          print('PASS appointment confirmation round-trip')
          "

      - name: Service unreachable
        if: steps.wake.outputs.awake != 'true'
        run: |
          echo "FAIL: $BASE_URL unreachable after 3 wake attempts"
          exit 1

      - name: Open GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Jorge Bot monitor failed -- ' + new Date().toISOString().slice(0,16) + ' UTC';
            const body = [
              '## Live monitor detected a failure',
              '',
              '**Run:** ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId,
              '',
              '**Triage links:**',
              '- Render dashboard: https://dashboard.render.com/web/srv-d6cecon5r7bs738qgi10',
              '- Health: https://jorge-realty-ai.onrender.com/api/health/live',
              '- OpenAPI: https://jorge-realty-ai.onrender.com/openapi.json',
              '',
              '_Auto-opened by monitor-jorge.yml_',
            ].join('\n');
            const {data: issues} = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'monitor-alert', state: 'open', per_page: 1,
            });
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body, labels: ['monitor-alert', 'bug'],
              });
            }

      - name: Close alert issue on recovery
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const {data: issues} = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'monitor-alert', state: 'open', per_page: 5,
            });
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Service recovered at ' + new Date().toISOString().slice(0,16) + ' UTC. Closing.',
              });
              await github.rest.issues.update({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: issue.number, state: 'closed',
              });
            }
