name: Claude Code Validation

on:
  push:
    branches: [main, develop]
    paths:
      - '.claude/**'
      - 'CLAUDE.md'
      - '.github/workflows/claude-code-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - '.claude/**'
      - 'CLAUDE.md'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  validate-setup:
    name: Validate Claude Code Setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Claude Code Configuration
        run: |
          bash .claude/scripts/validate-setup.sh

      - name: Check Token Optimization
        run: |
          # Count words in CLAUDE.md
          WORDS=$(wc -w < CLAUDE.md)
          echo "CLAUDE.md word count: $WORDS"

          if [ "$WORDS" -gt 1500 ]; then
            echo "❌ CLAUDE.md is too large ($WORDS words > 1500)"
            echo "Consider moving content to reference files"
            exit 1
          fi

          echo "✅ CLAUDE.md is optimized ($WORDS words)"

      - name: Verify Reference Files
        run: |
          # Check if reference files exist (in global location)
          # This is a basic check; full validation requires access to ~/.claude/
          echo "Checking for reference file documentation..."

          if grep -q "@reference/" CLAUDE.md; then
            echo "✅ CLAUDE.md references external files (progressive disclosure)"
          else
            echo "⚠️  No reference file links found in CLAUDE.md"
          fi

      - name: Check for Secrets in Commits
        run: |
          # Scan for potential secrets in recent commits
          echo "Scanning for potential secrets..."

          # Check staged files (for pre-commit scenario)
          if git diff --cached --name-only | grep -q "\.env$"; then
            echo "❌ FAIL: .env file is staged for commit"
            exit 1
          fi

          # Check for API keys in committed source files (exclude test/example/archive paths)
          SECRETS_FOUND=$(git log -1 --all -p -- 'ghl_real_estate_ai/*.py' 'advanced_rag_system/*.py' | \
            grep -E "^\+(API_KEY|SECRET|PASSWORD|TOKEN)\s*=\s*['\"][a-zA-Z0-9_\-]{20,}['\"]" || true)
          if [ -n "$SECRETS_FOUND" ]; then
            echo "❌ FAIL: Potential secrets found in recent commit"
            echo "$SECRETS_FOUND"
            exit 1
          fi

          echo "✅ No secrets detected"

      - name: Validate Hook Scripts
        run: |
          # Check if hook scripts are executable
          for script in .claude/scripts/hooks/*.sh; do
            if [ -f "$script" ]; then
              if [ -x "$script" ]; then
                echo "✅ $script is executable"
              else
                echo "⚠️  $script is not executable"
                chmod +x "$script"
              fi
            fi
          done

      - name: Generate Validation Report
        if: always()
        run: |
          echo "# Claude Code Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "**Date**: $(date -u +%Y-%m-%d)" >> validation-report.md
          echo "**Commit**: ${{ github.sha }}" >> validation-report.md
          echo "" >> validation-report.md

          # Add validation results
          if [ -f validation-results.txt ]; then
            cat validation-results.txt >> validation-report.md
          fi

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md

  validate-skills:
    name: Validate Skills System
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Skills Manifest
        run: |
          if [ ! -f ".claude/skills/MANIFEST.yaml" ]; then
            echo "⚠️  Skills manifest not found"
            exit 0
          fi

          # Count skills
          SKILL_COUNT=$(grep -c "^  name:" .claude/skills/MANIFEST.yaml || echo "0")
          echo "Skills count: $SKILL_COUNT"

          if [ "$SKILL_COUNT" -lt 1 ]; then
            echo "⚠️  No skills found in manifest"
          else
            echo "✅ Found $SKILL_COUNT skills"
          fi

      - name: Check Skill Files
        run: |
          if [ ! -f ".claude/skills/MANIFEST.yaml" ]; then
            exit 0
          fi

          # Extract skill directories from manifest
          grep "  path:" .claude/skills/MANIFEST.yaml | sed 's/.*: //' | while read -r path; do
            if [ -d ".claude/skills/$path" ]; then
              echo "✅ Skill directory exists: $path"
            else
              echo "⚠️  Skill directory missing: $path"
            fi
          done

  validate-hooks:
    name: Validate Hooks System
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Hook Definitions
        run: |
          HOOKS=("PreToolUse" "PostToolUse" "Stop")

          for hook in "${HOOKS[@]}"; do
            if [ -f ".claude/hooks/${hook}.md" ]; then
              echo "✅ Hook definition exists: ${hook}.md"

              # Check for required frontmatter
              if grep -q "^name:" ".claude/hooks/${hook}.md"; then
                echo "   ✅ Has name field"
              fi

              if grep -q "^events:" ".claude/hooks/${hook}.md"; then
                echo "   ✅ Has events field"
              fi
            else
              echo "⚠️  Hook definition missing: ${hook}.md"
            fi
          done

      - name: Validate Hook Scripts
        run: |
          SCRIPTS=("pre-tool-use.sh" "post-tool-use.sh" "stop.sh")

          for script in "${SCRIPTS[@]}"; do
            if [ -f ".claude/scripts/hooks/$script" ]; then
              echo "✅ Hook script exists: $script"

              # Check if executable
              if [ -x ".claude/scripts/hooks/$script" ]; then
                echo "   ✅ Is executable"
              else
                echo "   ⚠️  Not executable"
              fi

              # Check for proper shebang
              if head -1 ".claude/scripts/hooks/$script" | grep -q "^#!/bin/bash"; then
                echo "   ✅ Has bash shebang"
              fi

              # Check for exit 0 (permissive mode)
              if grep -q "exit 0" ".claude/scripts/hooks/$script"; then
                echo "   ✅ Has permissive exit code"
              fi
            else
              echo "⚠️  Hook script missing: $script"
            fi
          done

      - name: Test Hook Performance
        run: |
          # Test that pre-tool-use hook executes quickly
          if [ -f ".claude/scripts/hooks/pre-tool-use.sh" ]; then
            echo "Testing pre-tool-use.sh performance..."

            START=$(date +%s%3N)
            bash .claude/scripts/hooks/pre-tool-use.sh "Read" '{"file_path":"test.py"}' || true
            END=$(date +%s%3N)

            DURATION=$((END - START))

            if [ "$DURATION" -lt 500 ]; then
              echo "✅ Pre-tool-use hook executed in ${DURATION}ms (< 500ms target)"
            else
              echo "⚠️  Pre-tool-use hook took ${DURATION}ms (> 500ms target)"
            fi
          fi

  security-check:
    name: Security & Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Check for Secrets in Files
        run: |
          echo "Scanning for hardcoded secrets..."

          # Check source files for potential secrets (narrow scope to actual app code)
          # Excludes: archives, tests, examples, skills, scripts, config, integrations with enum constants
          if grep -r -E "(API_KEY|SECRET|PASSWORD|TOKEN)\s*=\s*['\"][a-zA-Z0-9_\-]{20,}['\"]" \
              --include="*.py" --include="*.ts" --include="*.js" \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              --exclude-dir=venv \
              --exclude-dir=_archive \
              --exclude-dir=auto-claude \
              --exclude-dir=tests \
              --exclude-dir=examples \
              --exclude-dir=skills \
              --exclude-dir=scripts \
              --exclude-dir=integrations \
              --exclude="*_test.*" \
              --exclude="*test_*" \
              --exclude="conftest.py" \
              --exclude="security_framework.py" \
              ghl_real_estate_ai/ advanced_rag_system/ 2>/dev/null; then
            echo "❌ FAIL: Potential hardcoded secrets found"
            exit 1
          fi

          echo "✅ No hardcoded secrets detected"

      - name: Verify .env is Gitignored
        run: |
          if [ -f ".gitignore" ]; then
            if grep -q "^\.env$" .gitignore; then
              echo "✅ .env is properly gitignored"
            else
              echo "❌ FAIL: .env is not in .gitignore"
              exit 1
            fi
          else
            echo "⚠️  No .gitignore file found"
          fi

      - name: Check Forbidden Paths Documentation
        run: |
          if grep -q "Forbidden Paths" CLAUDE.md || grep -q "NEVER Access" CLAUDE.md; then
            echo "✅ Forbidden paths are documented"
          else
            echo "⚠️  Forbidden paths not documented in CLAUDE.md"
          fi

  token-analysis:
    name: Token Usage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Estimate Token Count
        run: |
          # Rough token estimation (1 token ≈ 0.75 words)
          WORDS=$(wc -w < CLAUDE.md)
          TOKENS=$((WORDS * 4 / 3))

          echo "CLAUDE.md Statistics:"
          echo "- Words: $WORDS"
          echo "- Estimated tokens: $TOKENS"
          echo ""

          if [ "$TOKENS" -lt 5000 ]; then
            echo "✅ Excellent: $TOKENS tokens (< 5K target)"
          elif [ "$TOKENS" -lt 10000 ]; then
            echo "✅ Good: $TOKENS tokens (< 10K target)"
          elif [ "$TOKENS" -lt 20000 ]; then
            echo "⚠️  Warning: $TOKENS tokens (< 20K recommended)"
          else
            echo "❌ Poor: $TOKENS tokens (> 20K, needs optimization)"
            exit 1
          fi

      - name: Check for Reference Links
        run: |
          # Count reference file links
          REFS=$(grep -c "@reference/" CLAUDE.md || echo "0")

          echo ""
          echo "Reference file links: $REFS"

          if [ "$REFS" -gt 5 ]; then
            echo "✅ Good progressive disclosure ($REFS references)"
          elif [ "$REFS" -gt 0 ]; then
            echo "⚠️  Limited progressive disclosure ($REFS references)"
          else
            echo "❌ No progressive disclosure (monolithic file)"
          fi

  documentation-check:
    name: Documentation Accuracy Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Technology Stack Accuracy
        run: |
          # Check for incorrect Node.js references
          if grep -qi "node\.js\|typescript\|pnpm" CLAUDE.md; then
            echo "❌ FAIL: CLAUDE.md contains Node.js/TypeScript references"
            echo "This project uses Python/FastAPI/Streamlit"
            exit 1
          fi

          echo "✅ No incorrect technology references"

      - name: Verify Python Stack Documentation
        run: |
          # Check for correct Python references
          if ! grep -q "Python" CLAUDE.md; then
            echo "⚠️  Python not documented"
          fi

          if ! grep -q "FastAPI\|Streamlit" CLAUDE.md; then
            echo "⚠️  FastAPI/Streamlit not documented"
          fi

          if grep -q "Python" CLAUDE.md && grep -q "FastAPI\|Streamlit" CLAUDE.md; then
            echo "✅ Correct Python stack documented"
          fi

      - name: Check Skills Count
        run: |
          # Verify skills count is accurate
          if grep -q "31 " CLAUDE.md; then
            echo "✅ Skills count appears accurate (31 skills)"
          else
            echo "⚠️  Skills count may need verification"
          fi
