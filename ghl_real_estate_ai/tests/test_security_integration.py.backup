"""
Integration tests for security middleware
"""

import pytest
from fastapi.testclient import TestClient
from ghl_real_estate_ai.api.main import app
from ghl_real_estate_ai.ghl_real_estate_ai.api.middleware import JWTAuth

client = TestClient(app)


class TestSecurityHeaders:
    """Test security headers middleware."""
    
    def test_security_headers_present(self):
        """Verify security headers are added to responses."""
        response = client.get("/health")
        
        assert response.status_code == 200
        assert "X-Content-Type-Options" in response.headers
        assert response.headers["X-Content-Type-Options"] == "nosniff"
        assert "X-Frame-Options" in response.headers
        assert response.headers["X-Frame-Options"] == "DENY"
        assert "X-XSS-Protection" in response.headers
        assert "Strict-Transport-Security" in response.headers
        assert "Content-Security-Policy" in response.headers
        assert "Referrer-Policy" in response.headers


class TestRateLimiting:
    """Test rate limiting middleware."""
    
    def test_rate_limit_allows_normal_requests(self):
        """Test that normal request rates are allowed."""
        # Make a few requests (should be under limit)
        for _ in range(5):
            response = client.get("/health")
            assert response.status_code == 200
    
    def test_rate_limit_enforcement(self):
        """Test that excessive requests trigger rate limiting."""
        # This test is complex because rate limiting is IP-based
        # and TestClient uses the same client
        # For now, just verify the endpoint works
        response = client.get("/health")
        assert response.status_code == 200


class TestJWTAuthentication:
    """Test JWT authentication."""
    
    def test_login_endpoint_exists(self):
        """Verify login endpoint is available."""
        response = client.post(
            "/api/auth/login",
            json={"username": "demo_user", "password": "demo_password"}
        )
        
        # Should return 200 or 401 (both mean endpoint exists)
        assert response.status_code in [200, 401, 422]
    
    def test_valid_login_returns_token(self):
        """Test successful login returns JWT token."""
        response = client.post(
            "/api/auth/login",
            json={"username": "demo_user", "password": "demo_password"}
        )
        
        if response.status_code == 200:
            data = response.json()
            assert "access_token" in data
            assert "token_type" in data
            assert data["token_type"] == "bearer"
    
    def test_invalid_login_rejected(self):
        """Test invalid credentials are rejected."""
        response = client.post(
            "/api/auth/login",
            json={"username": "invalid", "password": "wrong"}
        )
        
        assert response.status_code == 401
    
    def test_protected_endpoint_requires_auth(self):
        """Test that protected endpoints require authentication."""
        response = client.get("/api/auth/me")
        
        # Should return 401 or 403 without token
        assert response.status_code in [401, 403]
    
    def test_protected_endpoint_with_valid_token(self):
        """Test protected endpoint access with valid token."""
        # First login
        login_response = client.post(
            "/api/auth/login",
            json={"username": "demo_user", "password": "demo_password"}
        )
        
        if login_response.status_code == 200:
            token = login_response.json()["access_token"]
            
            # Access protected endpoint
            response = client.get(
                "/api/auth/me",
                headers={"Authorization": f"Bearer {token}"}
            )
            
            assert response.status_code == 200
            data = response.json()
            assert "user_id" in data


class TestAPIKeyAuthentication:
    """Test API key authentication."""
    
    def test_api_key_auth_available(self):
        """Verify API key authentication is available."""
        from ghl_real_estate_ai.ghl_real_estate_ai.api.middleware import APIKeyAuth
        
        # Test key generation
        api_key = APIKeyAuth.generate_api_key()
        assert len(api_key) > 20
        
        # Test key hashing
        hashed = APIKeyAuth.hash_api_key(api_key)
        assert len(hashed) == 64  # SHA256 hex length


class TestIntegrationStatus:
    """Test overall security integration status."""
    
    def test_app_starts_successfully(self):
        """Verify app starts with all security features."""
        response = client.get("/")
        assert response.status_code == 200
    
    def test_health_endpoint_works(self):
        """Verify health endpoint works with security."""
        response = client.get("/health")
        assert response.status_code == 200
        assert response.json()["status"] == "healthy"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
