# ==============================================================================
# JORGE'S BI DASHBOARD - LOGSTASH CONFIGURATION
# Production log aggregation and processing pipeline
# ==============================================================================

# ==============================================================================
# INPUT SECTION
# ==============================================================================
input {
  # Docker container logs via Filebeat
  beats {
    port => 5044
    host => "0.0.0.0"
  }

  # Direct log files from Jorge BI backend
  file {
    path => [
      "/var/log/jorge-bi/application.log",
      "/var/log/jorge-bi/error.log",
      "/var/log/jorge-bi/access.log",
      "/var/log/jorge-bi/business.log"
    ]
    start_position => "beginning"
    codec => "json"
    type => "jorge-bi-application"
    tags => ["jorge-bi", "application"]
  }

  # Jorge business metrics logs
  file {
    path => "/var/log/jorge-bi/business-metrics.log"
    start_position => "beginning"
    codec => "json"
    type => "jorge-business-metrics"
    tags => ["jorge", "business", "metrics"]
  }

  # System logs
  syslog {
    port => 514
    type => "syslog"
    tags => ["system", "jorge-bi-infrastructure"]
  }

  # Application health check logs
  http_poller {
    urls => {
      "jorge_bi_health" => "http://bi-backend-1:8000/health"
      "jorge_bi_metrics" => "http://bi-backend-1:8000/metrics"
    }
    request_timeout => 10
    interval => 30
    codec => "json"
    type => "jorge-health-check"
    tags => ["jorge-bi", "health-check"]
  }
}

# ==============================================================================
# FILTER SECTION
# ==============================================================================
filter {
  # Parse and enrich Jorge BI application logs
  if [type] == "jorge-bi-application" {
    # Parse JSON structure
    json {
      source => "message"
    }

    # Add Jorge-specific fields
    mutate {
      add_field => {
        "service" => "jorge-bi-dashboard"
        "environment" => "production"
        "platform" => "jorge-real-estate-ai"
      }
    }

    # Parse timestamp
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    # Extract Jorge business context
    if [logger_name] =~ /jorge\.commission/ {
      mutate {
        add_field => {
          "business_context" => "commission_calculation"
          "commission_rate" => "0.06"
        }
        add_tag => ["jorge-commission"]
      }
    }

    if [logger_name] =~ /jorge\.leads/ {
      mutate {
        add_field => {
          "business_context" => "lead_management"
        }
        add_tag => ["jorge-leads"]
      }

      # Parse lead scoring information
      if [message] =~ /score:(\d+)/ {
        grok {
          match => { "message" => "score:(?<lead_score>\d+)" }
          add_field => {
            "lead_temperature" => "%{lead_score}"
          }
        }

        # Classify lead temperature based on Jorge's thresholds
        if [lead_score] {
          ruby {
            code => '
              score = event.get("lead_score").to_i
              if score >= 75
                event.set("lead_classification", "hot")
                event.set("jorge_priority", "high")
              elsif score >= 50
                event.set("lead_classification", "warm")
                event.set("jorge_priority", "medium")
              else
                event.set("lead_classification", "cold")
                event.set("jorge_priority", "low")
              end
            '
          }
        }
      }
    }

    if [logger_name] =~ /jorge\.bot/ {
      mutate {
        add_field => {
          "business_context" => "bot_performance"
        }
        add_tag => ["jorge-bot"]
      }
    }

    if [logger_name] =~ /jorge\.revenue/ {
      mutate {
        add_field => {
          "business_context" => "revenue_intelligence"
        }
        add_tag => ["jorge-revenue"]
      }
    }

    # Error classification and alerting
    if [level] == "ERROR" {
      mutate {
        add_tag => ["error", "needs-attention"]
        add_field => {
          "alert_priority" => "high"
        }
      }

      # Critical errors that need immediate attention
      if [message] =~ /(database|redis|anthropic|ghl).*error/ {
        mutate {
          add_tag => ["critical-error"]
          add_field => {
            "alert_priority" => "critical"
            "escalation_needed" => "true"
          }
        }
      }
    }

    # Performance monitoring
    if [message] =~ /duration:(\d+)ms/ {
      grok {
        match => { "message" => "duration:(?<duration_ms>\d+)ms" }
      }

      if [duration_ms] {
        ruby {
          code => '
            duration = event.get("duration_ms").to_i
            if duration > 1000
              event.set("performance_alert", "slow_response")
              event.set("alert_priority", "medium")
            elsif duration > 5000
              event.set("performance_alert", "very_slow_response")
              event.set("alert_priority", "high")
            end
          '
        }
      }
    }
  }

  # Parse Jorge business metrics logs
  if [type] == "jorge-business-metrics" {
    json {
      source => "message"
    }

    mutate {
      add_field => {
        "service" => "jorge-bi-dashboard"
        "environment" => "production"
        "metric_category" => "business"
      }
      add_tag => ["jorge-metrics", "business-intelligence"]
    }

    # Calculate commission metrics
    if [revenue_amount] and [commission_rate] {
      ruby {
        code => '
          revenue = event.get("revenue_amount").to_f
          rate = event.get("commission_rate").to_f
          commission = revenue * rate
          event.set("calculated_commission", commission)

          # Jorge target tracking
          monthly_target = 25000
          progress = (commission / monthly_target) * 100
          event.set("commission_progress_percent", progress)
        '
      }
    }
  }

  # Parse system logs
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{IPORHOST:logsource} %{PROG:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:syslog_message}" }
    }

    mutate {
      add_field => {
        "service" => "jorge-bi-infrastructure"
        "environment" => "production"
      }
    }
  }

  # Parse health check responses
  if [type] == "jorge-health-check" {
    mutate {
      add_field => {
        "service" => "jorge-bi-dashboard"
        "environment" => "production"
        "metric_type" => "health_check"
      }
      add_tag => ["jorge-health", "monitoring"]
    }

    # Parse health status
    if [status] == "healthy" {
      mutate {
        add_field => {
          "health_status" => "ok"
          "alert_priority" => "info"
        }
      }
    } else {
      mutate {
        add_field => {
          "health_status" => "degraded"
          "alert_priority" => "high"
        }
        add_tag => ["health-issue"]
      }
    }
  }

  # Common enrichment for all Jorge BI logs
  if "jorge-bi" in [tags] {
    # Add geographic and deployment context
    mutate {
      add_field => {
        "deployment_region" => "us-east-1"
        "customer" => "jorge-real-estate"
        "platform_version" => "2.0.0"
      }
    }

    # Add hostname information
    ruby {
      code => 'event.set("hostname", Socket.gethostname)'
    }

    # Parse IP addresses for security analysis
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }
  }

  # Remove unnecessary fields to reduce storage
  mutate {
    remove_field => ["host", "beat", "offset", "input", "prospector"]
  }

  # Security analysis for suspicious patterns
  if [message] =~ /(sql injection|xss|csrf|unauthorized|forbidden)/i {
    mutate {
      add_tag => ["security-alert", "suspicious-activity"]
      add_field => {
        "alert_priority" => "high"
        "security_concern" => "true"
      }
    }
  }
}

# ==============================================================================
# OUTPUT SECTION
# ==============================================================================
output {
  # Send all logs to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch-bi:9200"]

    # Dynamic index naming based on log type and date
    index => "jorge-bi-%{[type]}-%{+YYYY.MM.dd}"

    # Document type based on service
    document_type => "jorge-log"

    # Template for index settings
    template_name => "jorge-bi-logs"
    template => "/etc/logstash/templates/jorge-bi-template.json"
    template_overwrite => true

    # Performance optimization
    flush_size => 1000
    idle_flush_time => 10
  }

  # Send critical alerts to separate index
  if [alert_priority] == "critical" {
    elasticsearch {
      hosts => ["elasticsearch-bi:9200"]
      index => "jorge-bi-alerts-critical-%{+YYYY.MM.dd}"
      document_type => "critical-alert"
    }
  }

  # Send business metrics to specialized index
  if "jorge-metrics" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-bi:9200"]
      index => "jorge-business-metrics-%{+YYYY.MM.dd}"
      document_type => "business-metric"
    }
  }

  # Security events to security index
  if "security-alert" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-bi:9200"]
      index => "jorge-security-events-%{+YYYY.MM.dd}"
      document_type => "security-event"
    }
  }

  # Optional: Send to external SIEM or monitoring
  # http {
  #   url => "https://external-siem.company.com/api/logs"
  #   http_method => "post"
  #   headers => {
  #     "Authorization" => "Bearer ${SIEM_TOKEN}"
  #     "Content-Type" => "application/json"
  #   }
  #   codec => "json"
  #   mapping => {
  #     "timestamp" => "%{@timestamp}"
  #     "service" => "%{service}"
  #     "message" => "%{message}"
  #     "level" => "%{level}"
  #     "alert_priority" => "%{alert_priority}"
  #   }
  # }

  # Debug output for development (disabled in production)
  # stdout {
  #   codec => "json_lines"
  # }
}

# ==============================================================================
# JORGE-SPECIFIC LOGSTASH CONFIGURATION NOTES
# ==============================================================================
#
# This configuration is optimized for Jorge's BI Dashboard with:
#
# 1. BUSINESS INTELLIGENCE FOCUS:
#    - Commission calculation tracking (6% rate)
#    - Lead scoring and classification
#    - Bot performance monitoring
#    - Revenue intelligence logging
#
# 2. PERFORMANCE MONITORING:
#    - Response time analysis
#    - Error rate tracking
#    - Resource utilization
#    - Health check aggregation
#
# 3. SECURITY MONITORING:
#    - Suspicious activity detection
#    - Authentication failure tracking
#    - IP-based geographic analysis
#    - Security alert escalation
#
# 4. OPERATIONAL EXCELLENCE:
#    - Structured logging with business context
#    - Alert priority classification
#    - Automated escalation for critical issues
#    - Performance threshold monitoring
#
# 5. COMPLIANCE & AUDIT:
#    - Complete audit trail
#    - Business transaction logging
#    - Error classification and tracking
#    - Data retention policies
#
# ==============================================================================