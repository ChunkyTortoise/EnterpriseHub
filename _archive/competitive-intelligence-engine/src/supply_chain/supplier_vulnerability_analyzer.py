"""
Supplier Vulnerability Analyzer

This module provides 6-month early warning of supply chain disruptions
and analyzes supplier vulnerabilities. Part of the Supply Chain Intelligence Engine.

Key Capabilities:
- Early warning system for supplier insolvency or disruption
- Geopolitical risk assessment for supply routes
- Tier-N supplier dependency mapping and risk analysis

Value: Prevents multi-million dollar production stoppages and revenue loss.
"""

import asyncio
from datetime import datetime, timedelta
from typing import Dict, List, Optional
from dataclasses import dataclass
from enum import Enum
import logging

from ..core.ai_client import AIClient
from ..prediction.deep_learning_forecaster import DeepLearningForecaster

logger = logging.getLogger(__name__)

class VulnerabilitySeverity(Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

@dataclass
class SupplierVulnerability:
    supplier_id: str
    vulnerability_type: str
    severity: VulnerabilitySeverity
    probability: float
    detection_date: datetime
    predicted_impact_date: datetime
    financial_exposure: float
    risk_factors: List[str]
    recommended_mitigation: str

class SupplierVulnerabilityAnalyzer:
    """
    Analyzes supplier vulnerabilities and predicts disruptions.
    """

    def __init__(self, ai_client: AIClient, forecaster: DeepLearningForecaster):
        self.ai_client = ai_client
        self.forecaster = forecaster
        
        # Risk models
        self.risk_models = {
            "financial_health": "trained_financial_health_model",
            "geopolitical_risk": "trained_geopolitical_risk_model",
            "operational_stability": "trained_operational_stability_model"
        }

    async def analyze_supplier_network(
        self, 
        suppliers: List[Dict], 
        market_data: Dict
    ) -> List[SupplierVulnerability]:
        """
        Analyze the entire supplier network for vulnerabilities.
        """
        logger.info(f"Analyzing network of {len(suppliers)} suppliers for vulnerabilities")
        
        vulnerabilities = []
        
        # Parallel analysis of suppliers
        tasks = []
        for supplier in suppliers:
            tasks.append(self._analyze_single_supplier(supplier, market_data))
            
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        for result in results:
            if isinstance(result, SupplierVulnerability):
                vulnerabilities.append(result)
            elif isinstance(result, Exception):
                logger.error(f"Error analyzing supplier: {result}")
                
        # Sort by severity and financial exposure
        vulnerabilities.sort(
            key=lambda x: (x.severity == VulnerabilitySeverity.CRITICAL, x.financial_exposure), 
            reverse=True
        )
        
        return vulnerabilities

    async def _analyze_single_supplier(
        self, 
        supplier: Dict, 
        market_data: Dict
    ) -> Optional[SupplierVulnerability]:
        """
        Deep dive analysis of a single supplier using AI and predictive models.
        """
        supplier_id = supplier.get("id")
        supplier_name = supplier.get("name")
        
        # 1. Calculate risk score using predictive models
        risk_score = await self.forecaster.predict_supply_risk(
            supplier_features=supplier,
            market_context=market_data
        )
        
        if risk_score < 0.3:
            return None  # Low risk, no vulnerability report needed
            
        # 2. Determine severity
        severity = self._determine_severity(risk_score)
        
        # 3. AI analysis for context and mitigation
        analysis_prompt = f"""
        Analyze supply chain vulnerability for supplier: {supplier_name}
        Risk Score: {risk_score}
        
        Context:
        - Financial Health: {supplier.get('financial_rating')}
        - Geopolitical Region: {supplier.get('region')}
        - Criticality: {supplier.get('criticality')}
        
        Provide:
        1. Specific vulnerability type (e.g., Insolvency, Geopolitical Blockade, Capacity Constraint)
        2. List of key risk factors
        3. Recommended mitigation strategy
        """
        
        ai_analysis = await self.ai_client.generate_strategic_response(analysis_prompt)
        
        # Parse AI response (mock parsing logic for prototype)
        # In production, this would use structured output parsing
        
        vulnerability = SupplierVulnerability(
            supplier_id=supplier_id,
            vulnerability_type="Operational Instability", # Placeholder from AI analysis
            severity=severity,
            probability=risk_score,
            detection_date=datetime.now(),
            predicted_impact_date=datetime.now() + timedelta(days=90), # Predicted by model
            financial_exposure=supplier.get("annual_spend", 0) * risk_score,
            risk_factors=["High debt ratio", "Regional instability"], # Placeholder
            recommended_mitigation="Qualify alternative supplier immediately" # Placeholder
        )
        
        return vulnerability

    def _determine_severity(self, risk_score: float) -> VulnerabilitySeverity:
        if risk_score >= 0.85:
            return VulnerabilitySeverity.CRITICAL
        elif risk_score >= 0.65:
            return VulnerabilitySeverity.HIGH
        elif risk_score >= 0.45:
            return VulnerabilitySeverity.MEDIUM
        else:
            return VulnerabilitySeverity.LOW
