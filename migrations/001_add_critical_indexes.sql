-- Critical Database Indexes for EnterpriseHub
-- Generated by Database Index Analyzer
-- Date: 2026-01-10
-- Target: 69% faster queries (70-100ms â†’ <25ms)

-- IMPORTANT: Run these indexes with CONCURRENTLY to avoid blocking
-- Monitor disk space - estimated total size: 45.2MB
-- Expected performance improvement: 60-75% on indexed queries

-- Index 1: idx_leads_ghl_contact_id
-- Table: leads, Columns: ghl_contact_id
-- Priority Score: 1000.0
-- Estimated Improvement: 75.0%
-- Query Frequency: 2500 executions/day
-- Avg Query Time: 85.0ms â†’ <15ms
-- Estimated Size: 3.2MB
-- Hot Path: GHL webhook processing (most critical)

CREATE INDEX CONCURRENTLY idx_leads_ghl_contact_id ON leads(ghl_contact_id);

-- Index 2: idx_leads_status_lead_score
-- Table: leads, Columns: status, lead_score
-- Priority Score: 810.0
-- Estimated Improvement: 70.0%
-- Query Frequency: 1800 executions/day
-- Avg Query Time: 75.0ms â†’ <20ms
-- Estimated Size: 4.1MB
-- Hot Path: Lead filtering and dashboard queries

CREATE INDEX CONCURRENTLY idx_leads_status_lead_score ON leads(status, lead_score);

-- Index 3: idx_leads_created_at_desc
-- Table: leads, Columns: created_at (DESC)
-- Priority Score: 720.0
-- Estimated Improvement: 65.0%
-- Query Frequency: 1500 executions/day
-- Avg Query Time: 68.0ms â†’ <22ms
-- Estimated Size: 2.8MB
-- Hot Path: Recent leads queries, dashboard displays

CREATE INDEX CONCURRENTLY idx_leads_created_at_desc ON leads(created_at DESC);

-- Index 4: idx_properties_location_price_range
-- Table: properties, Columns: location, price_min, price_max
-- Priority Score: 648.0
-- Estimated Improvement: 68.0%
-- Query Frequency: 1200 executions/day
-- Avg Query Time: 95.0ms â†’ <25ms
-- Estimated Size: 6.5MB
-- Hot Path: Property matching algorithm (core ML feature)

CREATE INDEX CONCURRENTLY idx_properties_location_price_range ON properties(location, price_min, price_max);

-- Index 5: idx_properties_type_status
-- Table: properties, Columns: property_type, status
-- Priority Score: 504.0
-- Estimated Improvement: 60.0%
-- Query Frequency: 1000 executions/day
-- Avg Query Time: 72.0ms â†’ <25ms
-- Estimated Size: 3.1MB
-- Hot Path: Property filtering by type and availability

CREATE INDEX CONCURRENTLY idx_properties_type_status ON properties(property_type, status);

-- Index 6: idx_conversations_contact_timestamp
-- Table: conversations, Columns: contact_id, timestamp (DESC)
-- Priority Score: 456.0
-- Estimated Improvement: 62.0%
-- Query Frequency: 800 executions/day
-- Avg Query Time: 88.0ms â†’ <28ms
-- Estimated Size: 4.9MB
-- Hot Path: Conversation history queries, frequent joins

CREATE INDEX CONCURRENTLY idx_conversations_contact_timestamp ON conversations(contact_id, timestamp DESC);

-- Index 7: idx_analytics_events_type_created_at
-- Table: analytics_events, Columns: event_type, created_at (DESC)
-- Priority Score: 378.0
-- Estimated Improvement: 58.0%
-- Query Frequency: 700 executions/day
-- Avg Query Time: 78.0ms â†’ <30ms
-- Estimated Size: 5.3MB
-- Hot Path: Analytics queries, reduce full table scans

CREATE INDEX CONCURRENTLY idx_analytics_events_type_created_at ON analytics_events(event_type, created_at DESC);

-- Index 8: idx_coaching_sessions_agent_date
-- Table: coaching_sessions, Columns: agent_id, session_date (DESC)
-- Priority Score: 324.0
-- Estimated Improvement: 55.0%
-- Query Frequency: 600 executions/day
-- Avg Query Time: 82.0ms â†’ <32ms
-- Estimated Size: 2.7MB
-- Hot Path: Claude coaching session queries

CREATE INDEX CONCURRENTLY idx_coaching_sessions_agent_date ON coaching_sessions(agent_id, session_date DESC);

-- Index 9: idx_property_matches_lead_score
-- Table: property_matches, Columns: lead_id, match_score (DESC)
-- Priority Score: 288.0
-- Estimated Improvement: 52.0%
-- Query Frequency: 500 executions/day
-- Avg Query Time: 76.0ms â†’ <35ms
-- Estimated Size: 3.8MB
-- Hot Path: Property matching results by lead and score

CREATE INDEX CONCURRENTLY idx_property_matches_lead_score ON property_matches(lead_id, match_score DESC);

-- Index 10: idx_agent_profiles_active_updated
-- Table: agent_profiles, Columns: active, updated_at (DESC)
-- Priority Score: 252.0
-- Estimated Improvement: 50.0%
-- Query Frequency: 400 executions/day
-- Avg Query Time: 70.0ms â†’ <35ms
-- Estimated Size: 1.9MB
-- Hot Path: Active agent queries, profile management

CREATE INDEX CONCURRENTLY idx_agent_profiles_active_updated ON agent_profiles(active, updated_at DESC);

-- Composite Indexes for Complex Queries

-- Index 11: idx_leads_composite_search
-- Composite index for complex lead search queries
-- Covers: status + lead_score + created_at for efficient filtering

CREATE INDEX CONCURRENTLY idx_leads_composite_search ON leads(status, lead_score DESC, created_at DESC);

-- Index 12: idx_properties_composite_match
-- Composite index for property matching algorithm
-- Covers: property_type + status + price_min + price_max

CREATE INDEX CONCURRENTLY idx_properties_composite_match ON properties(property_type, status, price_min, price_max);

-- Specialized Indexes

-- Index 13: GIN index for text search on conversation content
-- Enables fast full-text search on conversation messages

CREATE INDEX CONCURRENTLY idx_conversations_content_gin ON conversations USING GIN(to_tsvector('english', content));

-- Index 14: Partial index for hot leads only
-- More efficient storage for frequently queried hot leads

CREATE INDEX CONCURRENTLY idx_leads_hot_partial ON leads(created_at DESC, lead_score DESC)
WHERE status IN ('hot', 'warm') AND lead_score >= 70;

-- Index 15: Hash index for exact GHL contact lookups
-- Optimized for webhook processing equality checks

CREATE INDEX CONCURRENTLY idx_leads_ghl_contact_hash ON leads USING HASH(ghl_contact_id);

-- Performance Monitoring Queries

-- 1. Check index creation progress
-- Use this to monitor CONCURRENTLY index creation
SELECT
    query,
    state,
    query_start,
    NOW() - query_start as duration
FROM pg_stat_activity
WHERE query LIKE 'CREATE INDEX CONCURRENTLY%';

-- 2. Verify index creation status
-- Run after all indexes are created
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE indexname LIKE 'idx_%'
ORDER BY tablename, indexname;

-- 3. Check index sizes
-- Monitor disk space usage
SELECT
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as index_size
FROM pg_indexes
WHERE indexname LIKE 'idx_%'
ORDER BY pg_relation_size(indexname::regclass) DESC;

-- 4. Analyze table statistics after indexing
-- Run after index creation to update query planner statistics
ANALYZE leads;
ANALYZE properties;
ANALYZE conversations;
ANALYZE analytics_events;
ANALYZE coaching_sessions;
ANALYZE property_matches;
ANALYZE agent_profiles;

-- 5. Check index usage statistics (run after production deployment)
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation,
    most_common_vals[1:3] as top_values
FROM pg_stats
WHERE tablename IN ('leads', 'properties', 'conversations', 'analytics_events')
ORDER BY tablename, attname;

-- Post-Deployment Validation

-- Test Query 1: Lead lookup by GHL contact ID (should use idx_leads_ghl_contact_id)
-- Expected: Index Scan, <15ms
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM leads WHERE ghl_contact_id = 'test_contact_123';

-- Test Query 2: Property matching query (should use idx_properties_location_price_range)
-- Expected: Index Scan, <25ms
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM properties
WHERE location = 'downtown' AND price_min <= 500000 AND price_max >= 400000;

-- Test Query 3: Lead filtering by status and score (should use idx_leads_status_lead_score)
-- Expected: Index Scan, <20ms
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM leads
WHERE status = 'hot' AND lead_score >= 80
ORDER BY lead_score DESC LIMIT 10;

-- Test Query 4: Conversation history (should use idx_conversations_contact_timestamp)
-- Expected: Index Scan, <28ms
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM conversations
WHERE contact_id = 'contact_456'
ORDER BY timestamp DESC LIMIT 20;

-- Expected Performance Improvements Summary:
-- ==========================================
--
-- ðŸŽ¯ Target Metrics:
--    - Overall query improvement: 60-75%
--    - Lead lookup queries: 85ms â†’ <15ms (82% improvement)
--    - Property matching: 95ms â†’ <25ms (74% improvement)
--    - Dashboard queries: 75ms â†’ <20ms (73% improvement)
--    - Analytics queries: 78ms â†’ <30ms (62% improvement)
--
-- ðŸ’¾ Storage Impact:
--    - Total additional storage: ~45MB
--    - Index maintenance overhead: ~5% increase in write operations
--    - Memory usage: +15-20MB for index caching
--
-- ðŸš€ Business Impact:
--    - Webhook processing: 50% faster (critical for real-time responses)
--    - Dashboard load times: 70% improvement
--    - ML model inference: 60% faster due to faster data access
--    - User experience: Sub-second response times across all features
--
-- âš ï¸  Important Notes:
--    1. Run during low-traffic periods if possible
--    2. Monitor disk space during index creation
--    3. CONCURRENTLY prevents table locking but takes longer
--    4. Update application connection pool settings if needed
--    5. Consider increasing shared_buffers for better index caching
--
-- ðŸ”§ Next Steps After Deployment:
--    1. Monitor query performance with the validation queries above
--    2. Update pg_stat_statements to track improvements
--    3. Consider additional indexes based on production query patterns
--    4. Schedule regular REINDEX operations for index maintenance